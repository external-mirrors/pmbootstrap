image: alpine:latest

# The mr-settings check needs to run in a MR specific context. With this block,
# the whole pipeline runs in that context for MRs. Otherwise we would have two
# pipelines for MRs.
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == 'master'
    - if: $CI_COMMIT_BRANCH == 'wip'
    - if: $CI_COMMIT_BRANCH == 'docs'

before_script: &global_before_scripts
  - ".ci/note.sh"
  - apk upgrade -U
  - "adduser -D build"
  # Force IPv4 for gitlab.postmarketos.org until it supports IPv6 too, OSUOSL is
  # working on it (infra#195)
  - "echo '140.211.167.182 gitlab.postmarketos.org' >> /etc/hosts"

stages:
  - lint
  - deploy
  - test

codespell:
  stage: lint
  script:
    - ".ci/codespell.sh"

pytest:
  stage: test
  script:
    - "apk -q add git"
    - "su build -c 'git config --global user.email ci@ci'"
    - "su build -c 'git config --global user.name CI'"
    - "echo 'build ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers"
    - ".ci/pytest.sh"
  after_script:
    - "cp /home/build/.local/var/pmbootstrap/log_testsuite.txt ."
    - "cp /home/build/.local/var/pmbootstrap/log.txt ."
  artifacts:
    when: on_failure
    paths:
      - "log_testsuite.txt"
      - "log.txt"

ruff:
  stage: lint
  script:
    - ".ci/ruff.sh"

shellcheck:
  stage: lint
  script:
    - ".ci/shellcheck.sh"

vermin:
  stage: lint
  script:
    - ".ci/vermin.sh"

mr-settings:
  stage: lint
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  before_script:
    - *global_before_scripts
    - "apk -q add python3"
    - "wget -q 'https://gitlab.postmarketos.org/postmarketOS/ci-common/-/raw/master/check_mr_settings.py'"
  script:
    - "python3 ./check_mr_settings.py"

mypy:
  stage: lint
  script:
    - ".ci/mypy.sh"

docs:
  stage: lint
  script:
    - ".ci/docs.sh"
  artifacts:
    paths:
      - public

deploy:
  only:
    - master
  stage: deploy
  before_script:
    - apk -q add openssh-client rsync
  script:
    - mkdir "${HOME}/.ssh"
    - echo "${SSH_HOST_KEY}" > "${HOME}/.ssh/known_hosts"
    - echo "${SSH_PRIVATE_KEY}" > "${HOME}/.ssh/id_ed25519"
    - chmod 700 "${HOME}/.ssh/id_ed25519"
    - rsync -hrvz --delete -e "ssh -p ${SSH_PORT}" public/ "${SSH_HOST}":/var/www/docs.postmarketos.org/pmbootstrap/
  environment:
    name: deploy

integration:
  stage: test
  before_script:
    - *global_before_scripts
    - apk upgrade -U
    - apk add doas git losetup multipath-tools python3 openssl
    - echo "permit nopass build" > /etc/doas.d/ci-user.conf
  script:
    - ".ci/integration.sh"
